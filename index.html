<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Kartonowy Nape≈Çniacz ‚Äî v0.008</title>
  <link rel="icon" href="favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --bg:#0e1117; --panel:#121826; --panel2:#0f1624; --text:#e5e7eb; --muted:#93a4b5; --accent:#22c55e; --line:#1f2937; --yellow:#fde047; }
    body[data-theme="light"] { --bg:#f3f4f6; --panel:#ffffff; --panel2:#f9fafb; --text:#111827; --muted:#6b7280; --accent:#16a34a; --line:#e5e7eb; }
    body[data-theme="light"] .btn{background:#e5e7eb;border-color:#d1d5db}
    body[data-theme="light"] .btn.primary{background:#16a34a;border-color:#15803d;color:white}
    body[data-theme="light"] .badge{background:#e5e7eb;color:#374151;border-color:#d1d5db}
    body[data-theme="light"] .progress, body[data-theme="light"] .pr-bar{background:#e5e7eb}
    body[data-theme="light"] .pr-head select.pr-select{background:var(--panel);border-color:var(--line);color:var(--text)}
    body[data-theme="light"] .pr-reset{background:var(--panel)}
    body[data-theme="light"] .stamp .chip{background:#e5e7eb;color:#374151;border-color:#d1d5db}
    body[data-theme="light"] .notes-list .row{border-bottom-color:#e5e7eb}
    body[data-theme="light"] .tag.draft{color:#92400e;border-color:#f59e0b;background:#fef3c7}
    body[data-theme="light"] .alert{background:#e5e7eb;color:#374151;border-color:#d1d5db}
    body[data-theme="blue"] { --bg:#0c1424; --panel:#101c36; --panel2:#0e1a31; --text:#e0e7ff; --muted:#a0b3d9; --accent:#60a5fa; --line:#1e294b; }
    body[data-theme="green"] { --bg:#052e16; --panel:#064e3b; --panel2:#043a2c; --text:#ecfdf5; --muted:#a7f3d0; --accent:#4ade80; --line:#022c22; }
    body{margin:0;background:linear-gradient(180deg,var(--panel),var(--panel2));color:var(--text);font:17px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif; transition: background .3s, color .3s;}
    .wrap{max-width:1200px;margin:auto;padding:12px 16px}
    .panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
    header .panel { opacity: 0.25; transition: opacity .3s ease-in-out; }
    header .panel:hover { opacity: 1; }
    .head{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--line)}
    .body{padding:10px 14px}
    .badge{font-size:12px;color:#cbd5e1;background:#0b1220;padding:4px 8px;border-radius:999px;border:1px solid var(--line)}
    .btn{border:1px solid var(--line);background:#0b1220;color:var(--text);padding:6px 10px;border-radius:10px;cursor:pointer}
    .btn.primary{background:#0d3b2c;border-color:#184c39}
    .btn.ghost{background:transparent}
    .machines{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.machines{grid-template-columns:1fr 1fr}}
    .machine .title{display:flex;align-items:center;gap:10px}
    .machine .title h2{margin:0;font-size:26px;letter-spacing:.3px}
    .meta{color:var(--muted);font-size:12px;margin:6px 0}
    .completion-time-container { font-size: 0.9rem; }
    .completion-time-container .completion-badge { font-size: 0.9rem; padding: 4px 8px; }
    .progress{margin-top:6px;height:18px;border:1px solid var(--line);border-radius:12px;background:#0b1220;position:relative;overflow:hidden}
    .progress .bar{position:absolute;inset:0 100% 0 0;background:linear-gradient(90deg,#22c55e,#86efac);transition:width .25s ease}
    .progress .label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:12px}
    .pruef{margin-top:10px}
    .pr-bar{position:relative;height:28px;border:1px solid var(--line);border-radius:14px;background:#0b1220;overflow:hidden}
    .pr-buttons button { font-size: 0.65rem; }
    .pr-fill{position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg,#22c55e,#84cc16);transition:width .5s linear}
    .pr-label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:700;letter-spacing:.3px;font-size:1.25rem}
    .pr-reset{position:absolute;right:10px;top:50%;transform:translateY(-50%);border:1px solid var(--line);background:var(--panel2);border-radius:8px;padding:4px 8px;cursor:pointer}
    .notes-list .row{display:flex;gap:10px;align-items:flex-start;border-bottom:1px dashed #263446;padding:8px 0}
    .stamp{display:inline-flex;gap:6px;align-items:center}
    .stamp .chip{background:#0b1220;border:1px solid #263446;border-radius:999px;padding:2px 6px}
    .stamp .small{font-size:12px;color:#9aa8b6}
    .stamp .digits{font-variant-numeric:tabular-nums;letter-spacing:.2px}
    .notes-list .txt{flex:1}
    .notes-list .act{display:flex;gap:6px}
    .tag{display:inline-block;margin-left:6px;font-size:12px;padding:2px 6px;border-radius:999px;border:1px solid #3b4760}
    .tag.draft{color:#eab308;border-color:#a16207;background:#2a2208}
    .role-badge{font-size:12px;padding:3px 8px;border-radius:999px;font-weight:600;border:1px solid transparent}
    .carton-box{position:relative;border:1px solid var(--line);border-radius:8px;overflow:hidden;background:var(--panel2)}
    .carton-fill{position:absolute;bottom:0;left:0;right:0;width:100%;height:0%;background-color:var(--accent);transition:height .5s linear}
    .carton-label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700}
    @keyframes blink-thumbnail { 50% { background-color: rgba(34, 197, 94, 0.25); border-color: rgba(34, 197, 94, 0.8); } }
    .carton-thumbnail.active-thumbnail { border: 1px solid var(--accent); animation: blink-thumbnail 2.5s infinite; }
    .carton-active-view .carton-label-large { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 700; }
    .carton-active-view .carton-label-large .carton-id { font-size: 1.5rem; }
    .carton-active-view .carton-label-large .carton-pieces { font-size: 1rem; font-variant-numeric: tabular-nums; }
    .carton-bag-container { display: flex; width: 100%; height: 100%; gap: 1px; }
    .carton-bag { flex: 1; position: relative; border: 1px solid var(--line); border-radius: 6px; overflow: hidden; background: var(--panel2); }
    .role-senior-dev{color:white;background-color:#3b82f6}
    .machine.minimized > .body > .meta,
    .machine.minimized > .body > .carton-progress-container,
    .machine.minimized > .body > .machine-settings { display: none; }
    @keyframes blink-fire { 50% { opacity: 0.2; } }
    #chatNewMessageIcon.blinking { display: inline-block !important; animation: blink-fire 1s infinite; }
    #chatBody.collapsed { display: none; }
    .role-teamleiter{color:white;background-color:#ec4899}
    .role-einrichter{color:white;background-color:#f97316}
    .role-admin{color:white;background-color:#60a5fa}
    .role-leiharbeiter{color:white;background-color:#9ca3af}
    .role-sanner-mitarbeiter{color:white;background-color:#22c55e}
    .role-user{color:white;background-color:#9ca3af}
    .user-info-popup{position:absolute;top:100%;left:0;z-index:10;width:280px;padding-top:8px;display:none;}
    .loginbar:hover .user-info-popup{display:block;}
    .user-info-popup .panel{border-width:2px;}
    .user-info-popup-grid{display:grid;grid-template-columns:100px 1fr;gap:12px;align-items:center;}
    .user-info-popup img{width:100px;height:100px;border-radius:12px;object-fit:cover;}
    #urgent-notifications .alert{color:white; border-color:transparent;}
    .alerts{display:flex;flex-wrap:wrap;gap:8px}
    .alert{display:flex;gap:8px;align-items:center;border:1px solid #2e3b53;border-radius:10px;padding:6px 10px;background:#0b1220}
    @keyframes blink-gradient { 50% { opacity: 0.3; } }
    .pruef-bar-finished { border-color: transparent !important; }
    .blinking-gradient-final { background: linear-gradient(90deg, #ef4444, transparent) !important; animation: blink-gradient 2s infinite; }
    .prufung-type-short { border: 1px solid var(--line) !important; }
    .prufung-type-long { border: 2px solid var(--text) !important; font-weight: bold; padding-left: 1rem !important; padding-right: 1rem !important; }
    .next-ready-checkbox:not(:checked) { filter: grayscale(1); }
  </style>
</head>
<body>
  <header class="wrap">
    <div id="urgent-notifications" class="space-y-2 mb-3"></div>
    <div class="panel">
      <div class="head">
        <div class="flex items-center gap-4">
          <img src="https://www.sanner-group.com/typo3conf/ext/sanner_site/Resources/Public/Icons/Sanner-Icons/Sanner-Logo-Claim.svg" alt="Sanner Logo" class="h-10">
          <div class="loginbar flex items-center gap-3 relative">
            <img id="userAvatar" src="https://placehold.co/40" alt="Avatar" class="w-8 h-8 rounded-full cursor-pointer">
            <div class="flex flex-col items-start">
              <div>
                <strong id="loginName">Kamil Kowalczyk</strong>
                <small id="loginId" class="opacity-70">(SoG1917)</small>
              </div>
              <span id="loginRole" class="role-badge" style="display: none;"></span>
            </div>
            <select id="loginSelect" class="btn"></select>
            <div class="user-info-popup">
            <div class="panel">
              <div class="body user-info-popup-grid">
                <img id="popupUserAvatar" src="https://placehold.co/184" alt="User Avatar">
                <div>
                  <h3 id="popupUserName" class="font-bold text-lg">Imiƒô Nazwisko</h3>
                  <p id="popupUserRole" class="text-sm"></p>
                  <p class="text-xs mt-2">Ostatnio zalogowany: <span id="popupLastLogin">teraz</span></p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="flex items-center gap-4">
            <div id="langSwitcher" class="flex gap-2">
              <button class="btn ghost text-xl" data-lang="pl" title="Polski">üáµüá±</button>
              <button class="btn ghost text-xl" data-lang="en" title="English">üá¨üáß</button>
              <button class="btn ghost text-xl" data-lang="tr" title="T√ºrk√ße">üáπüá∑</button>
              <button class="btn ghost text-xl" data-lang="de" title="Deutsch">üá©üá™</button>
              <button class="btn ghost text-xl" data-lang="ar" title="ÿßŸÑÿπÿ±ÿ®Ÿäÿ©">üá∏üá¶</button>
            </div>
            <div id="themeSwitcher" class="flex items-center gap-2">
              <button class="w-4 h-4 rounded-full border-2 border-white/20" style="background-color: #0e1117" data-theme="dark" title="Dark Theme"></button>
              <button class="w-4 h-4 rounded-full border-2 border-black/20" style="background-color: #f3f4f6" data-theme="light" title="Light Theme"></button>
              <button class="w-4 h-4 rounded-full border-2 border-white/20" style="background-color: #0c1424" data-theme="blue" title="Blue Theme"></button>
              <button class="w-4 h-4 rounded-full border-2 border-white/20" style="background-color: #052e16" data-theme="green" title="Green Theme"></button>
            </div>
            <button id="settingsBtn" class="btn ghost text-2xl">‚öôÔ∏è</button>
        </div>
      </div>
      <div class="body">
        <h1 class="m-0" data-translate-key="appTitle">üè≠ Kartonowy Nape≈Çniacz</h1>
        <div id="statusLine" class="opacity-80 mt-1" data-translate-key="statusReady"></div>
        <div id="chatStream" class="alerts mt-2"></div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section id="machines" class="machines"></section>

    <div id="newUserModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4">
      <div class="panel w-full max-w-md">
        <div class="head">
          <h2 class="m-0" data-translate-key="createUserTitle">Tworzenie nowego u≈ºytkownika</h2>
          <button id="closeModalBtn" class="btn ghost">‚úñ</button>
        </div>
        <div class="body">
          <form id="newUserForm" class="flex flex-col gap-4">
            <input type="text" id="newLogin" name="login" class="btn" data-translate-key="placeholderLogin" placeholder="Login (np. SoGxxxx, LK12, 1234)" required pattern="^(SoG[0-9]{4}|LK[0-9]{2}|[0-9]{2}|[0-9]{4})$">
            <input type="password" id="newPassword" name="password" class="btn" data-translate-key="placeholderPassword" placeholder="Has≈Ço (opcjonalne)">
            <input type="text" id="newName" name="name" class="btn" data-translate-key="placeholderName" placeholder="Imiƒô i nazwisko" required>
            <button type="submit" class="btn primary" data-translate-key="createUserBtn">Stw√≥rz u≈ºytkownika</button>
          </form>
        </div>
      </div>
    </div>

    <section id="chatWidget" class="panel mt-3">
      <div id="chatHeader" class="head cursor-pointer">
        <div class="flex items-center gap-2">
          <h2 class="m-0" data-translate-key="notesTitle">üí¨ CHAT</h2>
          <span id="chatNewMessageIcon" class="hidden text-xl">üî•</span>
        </div>
      </div>
      <div id="chatBody" class="body">
        <div class="flex gap-2 flex-wrap">
          <input id="noteInput" class="btn" style="flex:1" data-translate-key="placeholderNote" placeholder="Wpisz wiadomo≈õƒá...">
          <button id="addNote" class="btn primary" data-translate-key="addNoteBtn">Wy≈õlij</button>
        </div>
        <div id="notesList" class="notes-list mt-2"></div>
      </div>
    </section>

    <section class="panel mt-3">
      <div class="head"><h2 class="m-0" data-translate-key="plansTitle">üìå Dalsze plany</h2></div>
      <div class="body">
        <div class="flex gap-2 flex-wrap">
          <input id="planInput" class="btn" style="flex:1" data-translate-key="placeholderPlan" placeholder="Nowy pomys≈Ç / zadanie‚Ä¶">
          <button id="addPlan" class="btn" data-translate-key="addPlanBtn">+ Dodaj plan</button>
        </div>
        <div id="plansList" class="notes-list mt-2"></div>
      </div>
    </section>
  </main>

  <div id="userDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-40">
    <div class="panel w-full max-w-md">
      <div class="head">
        <h2 class="m-0">Uzupe≈Çnij swoje dane</h2>
      </div>
      <div class="body">
        <form id="userDetailsForm" class="flex flex-col gap-4">
          <p>To jest Twoje pierwsze logowanie. Prosimy o uzupe≈Çnienie danych. Pola sƒÖ opcjonalne.</p>
          <input type="text" id="detailsName" name="name" class="btn" placeholder="Imiƒô i nazwisko">
          <input type="text" id="detailsDob" name="dob" class="btn" placeholder="Data urodzenia (DD.MM.RRRR)">
          <select id="detailsLang" name="lang" class="btn">
            <option value="pl">Polski</option>
            <option value="en">English</option>
            <option value="tr">T√ºrk√ße</option>
            <option value="de">Deutsch</option>
            <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
          </select>
          <button type="submit" class="btn primary">Zapisz i kontynuuj</button>
        </form>
      </div>
    </div>
  </div>

  <div id="colorPicker" class="hidden absolute panel p-2 z-20">
    <div class="grid grid-cols-5 gap-1"></div>
  </div>

  <div id="customTimeModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-20">
    <div class="panel w-full max-w-xs">
      <div class="head">
        <h2 class="m-0">Ustaw czas</h2>
        <button id="closeTimeModalBtn" class="btn ghost">‚úñ</button>
      </div>
      <div class="body">
        <form id="customTimeForm" class="flex flex-col gap-4">
          <input type="number" id="customTimeInput" name="minutes" class="btn text-center text-lg" placeholder="Minuty" required>
          <button type="submit" class="btn primary">Ustaw</button>
        </form>
      </div>
    </div>
  </div>

  <div id="customConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
    <div class="panel w-full max-w-sm">
      <div class="body space-y-4">
        <p id="customConfirmMessage" class="text-center">Czy na pewno chcesz to zrobiƒá?</p>
        <div class="flex justify-center gap-4">
          <button id="customConfirmCancel" class="btn">Anuluj</button>
          <button id="customConfirmOk" class="btn primary">OK</button>
        </div>
      </div>
    </div>
  </div>

  <div id="swapMachineModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-30">
    <div class="panel w-full max-w-lg">
      <div class="head">
        <h2 class="m-0">Wybierz maszynƒô do zamiany</h2>
        <button id="closeSwapModalBtn" class="btn ghost">‚úñ</button>
      </div>
      <div id="swapMachineList" class="body grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2">
      </div>
    </div>
  </div>

  <div id="machineContextMenu" class="hidden absolute panel p-1 z-20">
    <div class="flex flex-col gap-1">
      <button class="btn ghost text-left" data-action="settings">‚öôÔ∏è Ustawienia</button>
      <button class="btn ghost text-left" data-action="reset_carton">üîÑ Resetuj karton</button>
      <button class="btn ghost text-left" data-action="swap">‚ÜîÔ∏è Zamie≈Ñ maszynƒô</button>
    </div>
  </div>

  <div id="cartonContextMenu" class="hidden absolute panel p-1 z-20">
    <div class="flex flex-col gap-1">
      <button class="btn ghost text-left" data-action="set_pieces">‚úèÔ∏è Ustaw sztuki</button>
      <button class="btn ghost text-left" data-action="start_from">‚û°Ô∏è Zacznij od tego</button>
      <button class="btn ghost text-left" data-action="set_start_number">#Ô∏è‚É£ Ustaw numer poczƒÖtkowy</button>
    </div>
  </div>

  <footer class="wrap" id="adminFooter" style="display: none;">
    <div class="panel mt-3">
      <div class="head">
        <h2 class="m-0">üîß Panel Admina</h2>
      </div>
      <div class="body">
        <p>Tutaj znajdƒÖ siƒô opcje administracyjne, takie jak zarzƒÖdzanie u≈ºytkownikami i ich uprawnieniami.</p>
        <div id="loginHistory" class="mt-4">
            <h3 class="font-bold border-b border-white/10 pb-1">Historia logowa≈Ñ</h3>
            <div id="loginHistoryList" class="notes-list mt-2 max-h-60 overflow-y-auto"></div>
        </div>
      </div>
    </div>
  </footer>

  <template id="tpl-machine">
    <article class="panel machine">
      <div class="head">
        <div class="title flex items-center gap-3">
          <img src="http://sannergmbh.beep.pl/v3/dasg/15-dasg-1-gray.png" class="machine-color-dot-large w-9 h-10 rounded-md object-contain" alt="Machine Color">
          <h2 class="code"></h2>
        </div>
        <div class="flex items-center gap-2 completion-time-container">
          <span class="opacity-70">Przewidywany czas do ko≈Ñca:</span>
          <div class="completion-badge role-badge bg-gray-500 text-white">--:--</div>
          <button class="btn ghost text-xl" data-action="minimize" title="Zminimalizuj / Rozwi≈Ñ">‚ûñ</button>
          <button class="btn ghost text-xl settings-toggle" data-action="settings" title="Ustawienia">‚öôÔ∏è</button>
        </div>
      </div>
      <div class="body">
        <div class="meta text-sm space-y-2">
          <div class="grid grid-cols-2 gap-2">
            <div class="border border-white/10 rounded-lg p-2">
              <span data-translate-key="auftrag">Auftrag:</span>
              <strong class="auf-val block font-bold text-base">‚Äî</strong>
            </div>
            <div class="border border-white/10 rounded-lg p-2">
              <span data-translate-key="nextAuftrag">Nastƒôpny Auftrag:</span>
              <strong class="nextauf-val block font-bold text-base">‚Äî</strong>
            </div>
          </div>
          <div class="border border-white/10 rounded-lg p-2">
            <div class="flex items-center gap-2">
                <span data-translate-key="model">Model:</span>
                <strong class="mdl-val font-bold text-base">‚Äî</strong>
                <img src="http://sannergmbh.beep.pl/v3/dasg/15-dasg-1-gray.png" class="model-color-dot ml-auto w-7 h-8 rounded-md cursor-pointer object-contain" title="Zmie≈Ñ kolor (PPM)">
            </div>
          </div>
          <div class="border border-white/10 rounded-lg p-2">
            <span data-translate-key="period">Okres:</span>
            <strong class="period-val block font-bold">‚Äî</strong>
          </div>
        </div>
        <div class="carton-progress-container mt-4 flex gap-4 items-center justify-center">
          <div class="carton-active-view carton-box w-32 h-40">
          </div>
          <div class="carton-thumbnails grid grid-cols-2 gap-1.5">
          </div>
        </div>
        <div class="pruef">
          <div class="pr-bar">
            <div class="pr-fill"></div><div class="pr-label">60:00</div>
            <div class="pr-buttons absolute right-[85px] top-1/2 -translate-y-1/2 flex gap-1">
              <button class="btn ghost !p-1 text-xs" data-time="3600">1H</button>
              <button class="btn ghost !p-1 text-xs" data-time="7200">2H</button>
              <button class="btn ghost !p-1 text-xs" data-time="10800">3H</button>
              <button class="btn ghost !p-1 text-xs" data-time="custom" data-translate-key="customTime">W≈ÅASNY</button>
            </div>
            <div class="pr-reset">Reset</div>
          </div>
        </div>
        <div class="machine-settings hidden mt-4 space-y-2">
          <h4 class="font-bold border-b border-white/10 pb-1">Ustawienia</h4>
          <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm items-center">
            <label>Model:</label>
            <input type="text" class="setting-input btn text-sm" data-source="order" data-key="model">
            <label>Czas (min):</label>
            <input type="number" class="setting-input btn text-sm w-24" data-source="machine" data-key="durationMin">
            <label>Sztuk w kartonie:</label>
            <input type="number" class="setting-input btn text-sm w-24" data-source="machine" data-key="piecesPerCarton">
            <label>Aktualny karton:</label>
            <input type="number" class="setting-input btn text-sm w-24" data-source="machine" data-key="currentCarton" min="1" max="4">
            <label>Czas uko≈Ñczenia:</label>
            <input type="text" class="setting-input btn text-sm" data-source="machine" data-key="completionTimestamp" placeholder="YYYY-MM-DD HH:MM:SS">
            <label>Nastƒôpny gotowy:</label>
            <input type="checkbox" class="setting-input h-5 w-5" data-source="order" data-key="nextReady">
          </div>
           <small class="text-xs opacity-60">Wci≈õnij ENTER (lub zmie≈Ñ pole), aby zapisaƒá.</small>
        </div>
      </div>
    </article>
  </template>
  <script>
    const SHARED_CFG_KEY = 'KN_SHARED_CFG_V1';
    const LOCAL_CFG_KEY = 'KN007_LOCAL_CFG_V1';
    const NOTES_KEY='KN007_NOTES';
    const PLANS_KEY='KN007_PLANS';
    const ADMIN_PASS = 4753;
    let USERS = {
      'SoG1917': { name: 'Kamil Kowalczyk', avatar: '', password: String(ADMIN_PASS) },
      'SoG2025': { name: 'John Locke', avatar: '' },
    };
    const DEFAULTS={
      user: { uid: 'SoG1917' },
      users: USERS,
      machines:[
        { code:'MA820061', durationMin:25, pruef:3600, piecesPerCarton: 3000, minimized: false },
        { code:'MA820062',  durationMin:22, pruef:3600, piecesPerCarton: 3000, minimized: false },
        { code:'MA820063', durationMin:25, pruef:3600, piecesPerCarton: 3000, minimized: false },
        { code:'MA820064', durationMin:25, pruef:3600, piecesPerCarton: 3000, minimized: false },
        { code:'MA820051', durationMin:25, pruef:3600, color: 'http://sannergmbh.beep.pl/v3/dasg/01-dasg-1-white.png', piecesPerCarton: 3000, minimized: true },
        { code:'MA820054', durationMin:25, pruef:3600, color: 'http://sannergmbh.beep.pl/v3/dasg/01-dasg-1-white.png', piecesPerCarton: 3000, minimized: true },
        { code:'MA820059', durationMin:50, pruef:3600, piecesPerCarton: 3000, minimized: true },
        { code:'MA820068', durationMin:25, pruef:3600, piecesPerCarton: 3000, minimized: true },
      ],
      orders:{
        'MA820051': { model: 'DASG-1 (201044)' },
        'MA820054': { model: 'DASG-1 (201044)' }
      },
    };
    let CFG = {};
    const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const isAdmin=()=> CFG.user?.uid==='SoG1917';
    let persistDebounceTimer;
    function persistLocalSettings() {
        const localCfg = { user: CFG.user, theme: CFG.theme };
        localStorage.setItem(LOCAL_CFG_KEY, JSON.stringify(localCfg));
    }
    function persist(){
        clearTimeout(persistDebounceTimer);
        persistDebounceTimer = setTimeout(() => {
            const sharedData = { ...CFG };
            delete sharedData.user;
            delete sharedData.theme;
            sharedData.lastUpdate = Date.now();
            saveShared(SHARED_CFG_KEY, sharedData);
        }, 1000);
    }
    async function saveShared(key,json){ try{ const res=await fetch('storage.php?a=set&key='+encodeURIComponent(key),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(json)}); const j=await res.json(); return !!j.ok; }catch(e){ console.error(e); return false; } }
    async function loadShared(key){ try{ const res=await fetch('storage.php?a=get&key='+encodeURIComponent(key)); const j=await res.json(); return j.v?JSON.parse(j.v):null; }catch(e){ console.error(e); return null; } }
    class Pruefung{
      constructor(machine, root){
        this.machine = machine; this.root=root; this.fill=$('.pr-fill',root); this.label=$('.pr-label',root); this.buttons=$$('.pr-buttons button',root); this.reset=$('.pr-reset',root); this.bar=$('.pr-bar', root); this.customButton = this.buttons.find(b => b.dataset.time === 'custom');
        this.total = this.machine.data.pruef || 3600; this.start=Date.now(); this.prufungType = 'short';
        this.bind(); this.updateCustomButtonBorder(); this.tick();
      }
      updateCustomButtonBorder() { this.customButton.classList.remove('prufung-type-short', 'prufung-type-long'); this.customButton.classList.add(this.prufungType === 'short' ? 'prufung-type-short' : 'prufung-type-long'); }
      togglePrufungType() { this.prufungType = this.prufungType === 'short' ? 'long' : 'short'; this.customButton.textContent = this.prufungType === 'short' ? 'Short' : 'Long üìè'; this.updateCustomButtonBorder(); }
      bind(){
        this.buttons.forEach(btn => {
            const v = btn.dataset.time;
            if (v === 'custom') { btn.textContent = 'Short'; btn.addEventListener('click', () => this.togglePrufungType());
            } else { btn.addEventListener('click', () => { this.buttons.forEach(b => b.classList.remove('primary')); btn.classList.add('primary'); this.total = parseInt(v, 10); this.start = Date.now(); this.machine.updatePruefTime(this.total); this.togglePrufungType(); }); }
        });
        this.reset.addEventListener('click', () => { this.start=Date.now(); this.buttons.forEach(b => b.classList.remove('primary')); this.togglePrufungType(); });
        this.bar.addEventListener('contextmenu', (e) => { e.preventDefault(); openCustomTimeModal((minutes) => this.setTime(minutes)); });
      }
      setTime(minutes) { this.total = Math.max(60, (parseInt(minutes, 10) || 0) * 60); this.start = Date.now(); this.buttons.forEach(b => b.classList.remove('primary')); this.machine.updatePruefTime(this.total); }
      tick(){
        const el = Math.min(this.total, Math.floor((Date.now()-this.start)/1000)); const left = this.total-el; const pct = this.total > 0 ? (el / this.total) : 0;
        this.fill.style.width = (pct * 100) + '%';
        if (left <= 0) {
            if (!this.bar.classList.contains('pruef-bar-finished')) { this.bar.classList.add('pruef-bar-finished'); this.fill.classList.add('blinking-gradient-final'); this.label.style.display = 'none'; }
        } else {
            if (this.bar.classList.contains('pruef-bar-finished')) { this.bar.classList.remove('pruef-bar-finished'); this.fill.classList.remove('blinking-gradient-final'); this.label.style.display = 'flex'; }
            const hue = 120 * (1 - pct); this.fill.style.background = `linear-gradient(90deg, hsl(${hue}, 80%, 50%), hsl(${hue}, 80%, 65%))`;
        }
        const mm = String(Math.floor(left/60)).padStart(2,'0'), ss = String(left%60).padStart(2,'0'); this.label.textContent = `${mm}:${ss}`;
        requestAnimationFrame(()=>this.tick());
      }
    }
    class CartonProgress {
        constructor(container, machineData, orderData) {
            this.container = container; this.machineData = machineData; this.isMA820059 = this.machineData.code === 'MA820059';
            this.totalPieces = this.machineData.piecesPerCarton || 3000; this.piecesPerBag = this.isMA820059 ? this.totalPieces : this.totalPieces; this.numBags = this.isMA820059 ? 2 : 1;
            const timePerCartonMs = (this.machineData.durationMin || 25) * 60 * 1000; this.timePerPiece = timePerCartonMs / (this.piecesPerBag * this.numBags);
            if (!this.machineData.cartonState) {
                this.machineData.cartonState = [ { id: 1, bags: Array(this.numBags).fill(null).map(()=>({pieces: 0})) }, { id: 2, bags: Array(this.numBags).fill(null).map(()=>({pieces: 0})) }, { id: 3, bags: Array(this.numBags).fill(null).map(()=>({pieces: 0})) }, { id: 4, bags: Array(this.numBags).fill(null).map(()=>({pieces: 0})) }, ];
            }
            this.startNumber = this.machineData.cartonStartNumber || 1;
            this.state = { currentCartonId: this.machineData.currentCarton || 1, startTime: this.machineData.cartonStartTime || Date.now(), cartons: this.machineData.cartonState, };
            this.machineData.cartonStartTime = this.state.startTime;
            this.initDOM(); this.setCurrentCarton(this.state.currentCartonId, false); this.tick();
        }
        initDOM() {
            this.activeView = $('.carton-active-view', this.container); this.thumbnailsContainer = $('.carton-thumbnails', this.container); this.thumbnails = [];
            this.thumbnailsContainer.innerHTML = '';
            for (let i = 1; i <= 4; i++) {
                const thumb = document.createElement('div'); thumb.className = 'carton-box carton-thumbnail w-12 h-16'; thumb.dataset.cartonId = i;
                const displayId = i + this.startNumber - 1; thumb.innerHTML = `<div class="carton-fill"></div><div class="carton-label text-xs">#${displayId}</div>`;
                this.thumbnailsContainer.appendChild(thumb); this.thumbnails.push(thumb);
                thumb.addEventListener('contextmenu', (e) => { e.preventDefault(); CartonContextMenuManager.open(this, i, e); });
            }
        }
        renderActiveView() {
            const carton = this.state.cartons[this.state.currentCartonId - 1]; if (!carton) return;
            this.activeView.innerHTML = ''; const activeDisplayId = this.state.currentCartonId + this.startNumber - 1;
            if (this.isMA820059) {
                this.activeView.innerHTML = `<div class="carton-label-large"><span class="carton-id">#${activeDisplayId}</span></div><div class="carton-bag-container"><div class="carton-bag"><div class="carton-fill"></div><div class="carton-label"></div></div><div class="carton-bag"><div class="carton-fill"></div><div class="carton-label"></div></div></div>`;
                const bagEls = $$('.carton-bag', this.activeView);
                for(let i = 0; i < this.numBags; i++) {
                    const bag = carton.bags[i] || {pieces: 0}; const progress = Math.min(1, bag.pieces / this.piecesPerBag);
                    $('.carton-fill', bagEls[i]).style.height = `${progress * 100}%`; $('.carton-label', bagEls[i]).textContent = `${bag.pieces}/${this.piecesPerBag}`;
                }
            } else {
                const bag = carton.bags[0] || {pieces: 0}; const progress = Math.min(1, bag.pieces / this.piecesPerBag);
                this.activeView.innerHTML = `<div class="carton-fill" style="height: ${progress * 100}%"></div><div class="carton-label-large"><span class="carton-id">#${activeDisplayId}</span><span class="carton-pieces">${bag.pieces}/${this.piecesPerBag}</span></div>`;
            }
        }
        renderThumbnails() {
            this.thumbnails.forEach((thumb, index) => {
                const carton = this.state.cartons[index]; if(!carton) return;
                const totalPieces = carton.bags.reduce((sum, bag) => sum + bag.pieces, 0); const totalCapacity = this.piecesPerBag * this.numBags;
                const progress = Math.min(1, totalPieces / totalCapacity);
                $('.carton-fill', thumb).style.height = `${progress * 100}%`;
                thumb.classList.toggle('active-thumbnail', carton.id === this.state.currentCartonId);
            });
        }
        setCurrentCarton(cartonId, resetProgress = true) {
            this.state.currentCartonId = cartonId; this.machineData.currentCarton = cartonId;
            if (resetProgress) {
                for (let i = cartonId - 1; i < this.state.cartons.length; i++) { if(this.state.cartons[i]) this.state.cartons[i].bags.forEach(b => b.pieces = 0); }
                const totalElapsedPieces = (this.state.currentCartonId - 1) * this.piecesPerBag * this.numBags;
                this.state.startTime = Date.now() - (totalElapsedPieces * this.timePerPiece); this.machineData.cartonStartTime = this.state.startTime;
            }
            this.tick();
        }
        setPieces(num) {
            const carton = this.state.cartons[this.state.currentCartonId - 1]; if (!carton) return;
            let currentBagIndex = 0;
            if(this.isMA820059) {
                 const totalElapsedMs = Date.now() - this.state.startTime; const totalPiecesProduced = Math.floor(totalElapsedMs / this.timePerPiece);
                 const piecesIntoCurrentCarton = totalPiecesProduced % (this.piecesPerBag * this.numBags); currentBagIndex = Math.floor(piecesIntoCurrentCarton / this.piecesPerBag);
                 if(currentBagIndex > 1) currentBagIndex = 1;
            }
            const bag = carton.bags[currentBagIndex]; if(!bag) return;
            bag.pieces = Math.max(0, Math.min(num, this.piecesPerBag));
            let totalElapsedPieces = (this.state.currentCartonId - 1) * this.piecesPerBag * this.numBags;
            for(let i=0; i<currentBagIndex; i++) { totalElapsedPieces += this.piecesPerBag; }
            totalElapsedPieces += bag.pieces;
            this.state.startTime = Date.now() - (totalElapsedPieces * this.timePerPiece); this.machineData.cartonStartTime = this.state.startTime;
            this.tick(); persist();
        }
        setStartNumber(num) { this.startNumber = num; this.machineData.cartonStartNumber = num; this.initDOM(); this.renderActiveView(); this.renderThumbnails(); persist(); }
        tick() {
            const totalElapsedMs = Date.now() - this.state.startTime; const totalPiecesProduced = Math.floor(totalElapsedMs / this.timePerPiece);
            const piecesPerCarton = this.piecesPerBag * this.numBags; const completedCartons = Math.floor(totalPiecesProduced / piecesPerCarton);
            const newCartonId = completedCartons + 1;
            if (newCartonId > 4) { this.state.currentCartonId = 4; } else { this.state.currentCartonId = newCartonId; }
            this.machineData.currentCarton = this.state.currentCartonId;
            for(let i = 0; i < 4; i++) {
                const carton = this.state.cartons[i]; if (!carton) continue;
                if (i < completedCartons) { carton.bags.forEach(b => b.pieces = this.piecesPerBag); } else if (i > completedCartons) { carton.bags.forEach(b => b.pieces = 0); }
            }
            const piecesIntoCurrentCarton = totalPiecesProduced % piecesPerCarton;
            const currentCarton = this.state.cartons[this.state.currentCartonId - 1];
            if(currentCarton) {
                if (this.isMA820059) {
                    const currentBagIndex = Math.floor(piecesIntoCurrentCarton / this.piecesPerBag);
                    if(currentBagIndex < 2) {
                        if(currentCarton.bags[0]) currentCarton.bags[0].pieces = (currentBagIndex > 0) ? this.piecesPerBag : (piecesIntoCurrentCarton % this.piecesPerBag);
                        if(currentCarton.bags[1]) currentCarton.bags[1].pieces = (currentBagIndex > 0) ? (piecesIntoCurrentCarton % this.piecesPerBag) : 0;
                    } else { currentCarton.bags.forEach(b => b.pieces = this.piecesPerBag); }
                } else { if(currentCarton.bags[0]) currentCarton.bags[0].pieces = piecesIntoCurrentCarton; }
            }
            this.renderActiveView(); this.renderThumbnails();
            if(Date.now() % 20 === 0) persist();
            requestAnimationFrame(() => this.tick());
        }
    }
    class Machine{ constructor(container,data,orders){ this.root=$('#tpl-machine').content.firstElementChild.cloneNode(true);
        this.data = data; this.orders = orders; this.code=data.code; this.codeEl = $('.code',this.root); this.codeEl.textContent = this.code; this.codeEl.style.cursor = 'pointer';
        this.codeEl.title = 'Kliknij, aby zamieniƒá maszynƒô'; this.codeEl.addEventListener('click', () => { openSwapModal(this); });
        const headEl = $('.head', this.root);
        headEl.addEventListener('contextmenu', (e) => { if (e.target.closest('.model-color-dot, .machine-color-dot-large')) return; ContextMenuManager.open(this, e); });
        if (!this.data.completionTimestamp) { this.data.completionTimestamp = Date.now() + (Math.floor(Math.random() * 14940) + 60) * 1000; }
        this.dot = $('.model-color-dot', this.root); this.dot.addEventListener('contextmenu', (e) => { PickerManager.open(this, e); });
        $('.machine-color-dot-large', this.root).addEventListener('contextmenu', (e) => { PickerManager.open(this, e); });
        this.completionBadgeEl = $('.completion-badge', this.root);
        this.completionBadgeEl.parentElement.addEventListener('contextmenu', (e) => { e.preventDefault(); openCustomTimeModal((minutes) => { const newTimestamp = Date.now() + (minutes * 60 * 1000); this.data.completionTimestamp = newTimestamp; this.updateCompletionTime(); persist(); }); });
        this.settingsToggle = $('.settings-toggle', this.root); this.minimizeBtn = $('[data-action="minimize"]', this.root); this.settingsPanel = $('.machine-settings', this.root); this.settingsInputs = $$('.setting-input', this.settingsPanel);
        this.settingsToggle.addEventListener('click', () => this.settingsPanel.classList.toggle('hidden'));
        this.minimizeBtn.addEventListener('click', () => { this.data.minimized = !this.data.minimized; this.render(); persist(); });
        this.settingsInputs.forEach(input => {
            const eventType = input.type === 'checkbox' ? 'change' : 'keyup';
            input.addEventListener(eventType, (e) => { if (eventType === 'change' || e.key === 'Enter') { this.saveSetting(e.target); } });
        });
        container.appendChild(this.root); this.pr = new Pruefung(this, $('.pruef', this.root));
        this.cartons = new CartonProgress($('.carton-progress-container', this.root), data, this.orders);
        this.render(); this.updateCompletionTime(); this.completionInterval = setInterval(() => this.updateCompletionTime(), 60000);
    }
      updatePruefTime(newTotalInSeconds) { this.data.pruef = newTotalInSeconds; persist(); }
      saveSetting(input) {
        const key = input.dataset.key; const source = input.dataset.source; let value;
        if (input.type === 'checkbox') { value = input.checked; } else if (input.type === 'number') { value = parseFloat(input.value) || 0; } else { value = input.value; }
        if (key === 'completionTimestamp' && typeof value === 'string' && value.includes('-')) { value = new Date(value).getTime(); if (isNaN(value)) { alert('Nieprawid≈Çowy format daty!'); return; } }
        if (source === 'machine') { this.data[key] = value; } else if (source === 'order') { if (!this.orders[this.code]) this.orders[this.code] = genOrder(); this.orders[this.code][key] = value; }
        if (key === 'currentCarton') { this.cartons.setCurrentCarton(parseInt(value, 10)); }
        if (key === 'model' && String(value).includes('201044')) { this.data.color = 'http://sannergmbh.beep.pl/v3/dasg/01-dasg-1-white.png'; }
        input.blur(); this.render(); persist();
      }
      render() {
        this.root.classList.toggle('minimized', !!this.data.minimized); this.minimizeBtn.textContent = this.data.minimized ? '‚ûï' : '‚ûñ';
        const order = this.orders[this.code] || {}; $('.auf-val',this.root).textContent = order.auftrag || '‚Äî'; $('.mdl-val',this.root).textContent = order.model || '‚Äî'; $('.period-val',this.root).textContent = order.period || '‚Äî';
        const nextAufVal = order.next || '‚Äî'; const nextReadyCheck = order.nextReady ? ' <span class="text-green-400">‚úîÔ∏è</span>' : ''; $('.nextauf-val',this.root).innerHTML = nextAufVal + nextReadyCheck;
        const colorUrl = this.data.color || 'http://sannergmbh.beep.pl/v3/dasg/15-dasg-1-gray.png'; this.dot.src = colorUrl;
        const largeDot = $('.machine-color-dot-large', this.root); if (largeDot) largeDot.src = colorUrl;
        const isLightTheme = document.body.dataset.theme === 'light';
        if (this.data.color && this.data.color.includes('white') && isLightTheme) { this.dot.style.border = '1px solid #9ca3af'; if(largeDot) largeDot.style.border = '1px solid #9ca3af'; } else { this.dot.style.border = 'none'; if(largeDot) largeDot.style.border = 'none'; }
        this.settingsInputs.forEach(input => {
            const key = input.dataset.key; const source = input.dataset.source; let value;
            if (source === 'machine') { value = this.data[key]; } else if (source === 'order') { value = order[key]; }
            if (input.type === 'checkbox') { input.checked = !!value; } else if (key === 'completionTimestamp' && value) { input.value = new Date(value).toISOString().slice(0, 19).replace('T', ' '); } else { input.value = value || ''; }
        });
      }
      setColor(color) { this.data.color = color; this.render(); persist(); }
      updateCompletionTime() {
        const now = Date.now(); const timeLeft = Math.max(0, Math.floor((this.data.completionTimestamp - now) / 1000));
        const hours = Math.floor(timeLeft / 3600); const minutes = Math.floor((timeLeft % 3600) / 60);
        this.completionBadgeEl.textContent = `${String(hours)}h ${String(minutes).padStart(2, '0')}m`;
        const twoHours = 2 * 3600; this.completionBadgeEl.className = 'completion-badge role-badge text-white';
        if (timeLeft <= 0) { this.completionBadgeEl.classList.add('bg-yellow-400', 'text-black', 'font-bold'); } else if (timeLeft <= twoHours) { this.completionBadgeEl.classList.add('bg-red-600'); } else if (timeLeft <= 8 * 3600) { this.completionBadgeEl.classList.add('bg-orange-500'); } else if (timeLeft <= 15 * 3600) { this.completionBadgeEl.classList.add('bg-yellow-500'); } else { this.completionBadgeEl.classList.add('bg-gray-500'); }
        if (timeLeft > 0 && timeLeft < twoHours) { showUrgentNotification(this.code, `Koniec Auftragu ${this.code} w ciƒÖgu ${Math.ceil(timeLeft/3600)} godzin!`); } else { hideUrgentNotification(this.code); }
      }
    }
    function renderMachines(){
        const box=$('#machines'); box.innerHTML='';
        (CFG.machines||[]).forEach(m=> {
            try { new Machine(box,m, CFG.orders||{}); } catch (e) {
                console.error("Failed to render machine:", m.code, e);
                const errorEl = document.createElement('div'); errorEl.className = 'panel machine';
                errorEl.innerHTML = `<div class="head"><h2>Error loading machine: ${m.code}</h2></div><div class="body"><pre>${e.stack}</pre></div>`;
                box.appendChild(errorEl);
            }
        });
    }
    let NOTES=[], PLANS=[], lastNoteCount = 0;
    function renderNotes(){
      const list=$('#notesList'); list.innerHTML='';
      NOTES.forEach(n=>{
        const row=document.createElement('div'); row.className='row'; const tag = n.status==='DRAFT' ? '<span class="tag draft">DRAFT</span>' : '';
        row.innerHTML=`<div class="meta">${makeStamp(n.ts, {uid:n.user,name:n.userName})} ${tag}</div><div class="txt">${n.text}</div><div class="act"></div>`;
        const act=$('.act',row);
        if(isAdmin()){
          const bE=document.createElement('button');bE.className='btn';bE.textContent='‚úèÔ∏è';bE.title='Edytuj';
          const bR=document.createElement('button');bR.className='btn';bR.textContent='‚Ü©Ô∏è';bR.title='Odpowiedz';
          const bD=document.createElement('button');bD.className='btn';bD.textContent='üóëÔ∏è';bD.title='Usu≈Ñ';
          bE.onclick=async()=>{ const v=prompt('Edytuj notatkƒô', n.text); if(v!=null){ n.text=v; await saveNotes(); renderNotes(); } };
          bR.onclick=async()=>{ const v=prompt('Odpowied≈∫', ''); if(v){ NOTES.push({id:Date.now()+Math.random(),ts:Date.now(),user:CFG.user.uid,userName:CFG.user.name,text:`‚Ü™ ${v} (odpowied≈∫ na #${n.id})`,status:'FINAL'}); await saveNotes(); renderNotes(); } };
          bD.onclick=async()=>{ if(confirm('UsunƒÖƒá notatkƒô?')){ NOTES = NOTES.filter(x=>x.id!==n.id); await saveNotes(); renderNotes(); } };
          act.append(bE,bR,bD);
        }
        list.appendChild(row);
      });
    }
    async function saveNotes(){ await saveShared(NOTES_KEY, NOTES); }
    async function loadNotes(){
        const db=await loadShared(NOTES_KEY);
        if(db){
            if (lastNoteCount > 0 && db.length > lastNoteCount && $('#chatBody').classList.contains('collapsed')) { $('#chatNewMessageIcon').classList.add('blinking'); }
            NOTES=db; lastNoteCount = db.length;
        }
        renderNotes();
    }
    async function savePlans(){ await saveShared(PLANS_KEY, PLANS); }
    async function loadPlans(){ const db=await loadShared(PLANS_KEY); if(db){ PLANS=db; } renderPlans(); }
    function initNotesPlans(){
      const addNoteAction = async () => {
        const v=$('#noteInput').value.trim(); if(!v) return;
        NOTES.push({id:Date.now()+Math.random(), ts:Date.now(), user:CFG.user.uid, userName:CFG.user.name, text:v, status:'FINAL'});
        $('#noteInput').value=''; await saveNotes(); renderNotes();
        $('#chatNewMessageIcon').classList.remove('blinking'); lastNoteCount = NOTES.length;
      };
      $('#addNote').onclick = addNoteAction;
      $('#noteInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addNoteAction(); } });
      const chatHeader = $('#chatHeader'); const chatBody = $('#chatBody'); const chatIcon = $('#chatNewMessageIcon');
      chatHeader.addEventListener('click', () => {
          chatBody.classList.toggle('collapsed');
          if (!chatBody.classList.contains('collapsed')) { chatIcon.classList.remove('blinking'); lastNoteCount = NOTES.length; chatBody.classList.add('user-opened'); }
      });
      setTimeout(() => { if(!chatBody.classList.contains('user-opened')) { chatBody.classList.add('collapsed'); } }, 5000);
      $('#addPlan').onclick=async()=>{ const v=$('#planInput').value.trim(); if(!v) return; PLANS.push({id:Date.now()+Math.random(), ts:Date.now(), user:CFG.user.uid, userName:CFG.user.name, text:v}); $('#planInput').value=''; await savePlans(); renderPlans(); };
      loadNotes(); loadPlans();
      setInterval(() => { loadNotes(); loadPlans(); loadSharedConfig(); }, 30000);
    }
    function initThemeSwitcher() {
      const themeButtons = $$('#themeSwitcher button'); const body = document.body;
      function applyTheme(theme) { body.dataset.theme = theme; CFG.theme = theme; persistLocalSettings(); }
      if (CFG.theme) { body.dataset.theme = CFG.theme; }
      themeButtons.forEach(button => { button.addEventListener('click', () => { applyTheme(button.dataset.theme); }); });
    }
    function openCustomTimeModal(callback) { const modal = $('#customTimeModal'); activeTimeSetterCallback = callback; modal.classList.remove('hidden'); $('#customTimeInput').focus(); }
    function initCustomTimeModal() {
        const modal = $('#customTimeModal'); const form = $('#customTimeForm'); const input = $('#customTimeInput'); const closeBtn = $('#closeTimeModalBtn');
        const close = () => { modal.classList.add('hidden'); input.value = ''; activeTimeSetterCallback = null; }
        form.addEventListener('submit', (e) => { e.preventDefault(); if (activeTimeSetterCallback) { activeTimeSetterCallback(input.value); } close(); return false; });
        closeBtn.onclick = close;
    }
    async function main() {
        const sharedCfg = await loadShared(SHARED_CFG_KEY);
        const localCfg = JSON.parse(localStorage.getItem(LOCAL_CFG_KEY) || '{}');
        if (sharedCfg) { CFG = sharedCfg; } else { console.log('No shared config found in DB, using DEFAULTS.'); CFG = JSON.parse(JSON.stringify(DEFAULTS)); }
        CFG.user = localCfg.user || DEFAULTS.user; CFG.theme = localCfg.theme || 'dark';
        if (!CFG.machines || !Array.isArray(CFG.machines) || CFG.machines.length < 8) { console.log('Incomplete machine data detected. Restoring defaults.'); CFG.machines = DEFAULTS.machines; }
        if (CFG.users) { USERS = CFG.users; } else { CFG.users = USERS; }
        initThemeSwitcher(); initLangSwitcher(); initMachines(); initLogin(); initNotesPlans(); initUserDetailsModal(); renderAdminPanel(); initCustomTimeModal(); initSwapMachineModal(); initSettings();
        if (!sharedCfg) { persist(); }
    }
    main();
  </script>
</body>
</html>
